# =============================================================================
# Microsoft Fabric Lakehouse Backup Pipeline (Scheduled)
# =============================================================================
# This pipeline runs automated backups on a schedule. Configure the cron
# expression below to match your backup requirements.
#
# Default Schedule: Daily at 12:30 AM AEST (14:30 UTC)
#
# Prerequisites:
#   1. Service Principal with Fabric API permissions
#   2. Azure DevOps Service Connection configured
#   3. Variable groups for each environment with workspace/lakehouse names
#   4. Backup notebook deployed to your Fabric workspace
#
# See README.md for detailed setup instructions.
# =============================================================================

trigger: none

# Schedule configuration
# Modify the cron expression to match your backup requirements
# Format: minute hour day-of-month month day-of-week
schedules:
  - cron: "30 14 * * *"  # Daily at 12:30 AM AEST (14:30 UTC)
    displayName: Daily Lakehouse Backup
    branches:
      include:
        - main
    always: true  # Run even if no code changes

# ---------- Pipeline Parameters ----------
parameters:
  - name: environment
    displayName: Target Environment
    type: string
    values:
      - dev
      - tst
      - prd
    default: prd

  - name: agentType
    displayName: Agent Type
    type: string
    values:
      - self-hosted
      - ms-hosted
    default: ms-hosted

  - name: source_lakehouse
    displayName: Source Lakehouse to Backup
    type: string
    values:
      - lakehouse1
      - lakehouse2
      - all
    default: all

  - name: backup_tables
    displayName: Backup Tables
    type: string
    values:
      - "true"
      - "false"
    default: "true"

  - name: backup_files
    displayName: Backup Files
    type: string
    values:
      - "true"
      - "false"
    default: "true"

  - name: timeout_in_minutes
    displayName: Timeout in Minutes
    type: number
    default: 90

# ---------- Variables ----------
variables:
  # -------------------------------------------------------------------------
  # IMPORTANT: Customize these for your organization
  # -------------------------------------------------------------------------
  
  # Import workspace ID variable groups based on selected environment
  # These variable groups should contain:
  #   - lakehouse_backup_workspace_id: Workspace ID where backup notebook resides
  #   - lakehouse1_name: Name of first lakehouse to backup (e.g., "lh_silver1")
  #   - lakehouse2_name: Name of second lakehouse to backup (e.g., "lh_silver2")
  #   - source_workspace_name: Name of workspace containing source lakehouses
  - ${{ if eq(parameters.environment, 'dev') }}:
    - group: 'fabric-workspaces-dev'
  - ${{ elseif eq(parameters.environment, 'tst') }}:
    - group: 'fabric-workspaces-tst'
  - ${{ else }}:
    - group: 'fabric-workspaces-prd'

  # Service connection name
  - name: serviceConnection
    value: "fabric-service-connection-${{ parameters.environment }}"

  # Agent pool for self-hosted agents
  - name: selfHostedAgentPoolName
    value: "default"

  # Notebook name
  - name: notebook_name
    value: "nb_lakehouse_backup"

  # Environment display name
  - name: environment_name
    value: "${{ upper(parameters.environment) }}"

  # Backup destination naming
  - name: backup_lakehouse_name
    value: "lh_${{ lower(parameters.environment) }}_backup"

  - name: backup_workspace_name
    value: "ws-${{ lower(parameters.environment) }}-backup"

  - name: timeout_in_minutes
    value: "${{ parameters.timeout_in_minutes }}"

# ---------- Stages ----------
stages:
  - stage: ScheduledLakehouseBackup
    displayName: "Scheduled Backup - ${{ parameters.environment }}"
    
    ${{ if eq(parameters.agentType, 'ms-hosted') }}:
      pool:
        vmImage: ubuntu-latest
    ${{ else }}:
      pool: $(selfHostedAgentPoolName)
    
    jobs:
      # =====================================================================
      # Job: Backup Lakehouse 1 (if selected or 'all')
      # =====================================================================
      - ${{ if or(eq(parameters.source_lakehouse, 'lakehouse1'), eq(parameters.source_lakehouse, 'all')) }}:
        - job: backup_lakehouse1
          displayName: Backup Lakehouse 1
          timeoutInMinutes: ${{ parameters.timeout_in_minutes }}

          steps:
          - task: AzurePowerShell@5
            displayName: 'Find Backup Notebook'
            inputs:
              azureSubscription: '${{ variables.serviceConnection }}'
              ScriptType: 'InlineScript'
              Inline: |
                # Get lakehouse name for logging
                $lakehouseName = [System.Environment]::GetEnvironmentVariable("LAKEHOUSE1_NAME")
                if (-not $lakehouseName) { $lakehouseName = "Lakehouse 1" }
                
                Write-Host "üîç Finding backup notebook for: $lakehouseName"
                
                $workspaceId = [System.Environment]::GetEnvironmentVariable("LAKEHOUSE_BACKUP_WORKSPACE_ID")
                
                if (-not $workspaceId) {
                    Write-Host "‚ùå LAKEHOUSE_BACKUP_WORKSPACE_ID not found"
                    exit 1
                }
                
                $bearerToken = (Get-AzAccessToken -AsSecureString -ResourceUrl "https://api.fabric.microsoft.com").Token | ConvertFrom-SecureString -AsPlainText
                $headers = @{
                  "Authorization" = "Bearer $bearerToken"
                  "Content-Type"  = "application/json"
                }
                
                $apiUrl = "https://api.fabric.microsoft.com/v1/workspaces/$workspaceId/notebooks"
                $list = Invoke-RestMethod -Uri $apiUrl -Headers $headers -Method GET
                $notebookId = ($list.value | Where-Object {$_.displayName -eq "$(notebook_name)"}).id
                
                if (-not $notebookId) {
                    Write-Host "‚ùå Notebook '$(notebook_name)' not found"
                    exit 1
                }
                
                Write-Host "‚úÖ Found notebook: $(notebook_name) ($notebookId)"
                Write-Host "##vso[task.setvariable variable=notebookId;]$notebookId"
                Write-Host "##vso[task.setvariable variable=workspaceId;]$workspaceId"
                Write-Host "##vso[task.setvariable variable=lakehouseName;]$lakehouseName"
              azurePowerShellVersion: 'LatestVersion'

          - task: AzurePowerShell@5
            displayName: 'Execute Backup for Lakehouse 1'
            inputs:
              azureSubscription: '${{ variables.serviceConnection }}'
              ScriptType: 'InlineScript'
              Inline: |
                $lakehouseName = "$(lakehouseName)"
                Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                Write-Host "üíæ Starting Backup: $lakehouseName"
                Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                
                $workspaceId = "$(workspaceId)"
                $fabricToken = (Get-AzAccessToken -AsSecureString -ResourceUrl "https://api.fabric.microsoft.com").Token | ConvertFrom-SecureString -AsPlainText
                $headers = @{
                    "Authorization" = "Bearer $fabricToken"
                    "Content-Type" = "application/json"
                }
                
                # Get lakehouse names from variable group
                $sourceLakehouseName = [System.Environment]::GetEnvironmentVariable("LAKEHOUSE1_NAME")
                $sourceWorkspaceName = [System.Environment]::GetEnvironmentVariable("SOURCE_WORKSPACE_NAME")
                $backupLakehouseName = "$(backup_lakehouse_name)"
                $backupWorkspaceName = "$(backup_workspace_name)"
                
                if (-not $sourceLakehouseName) {
                    Write-Host "‚ùå LAKEHOUSE1_NAME not found in variable group"
                    exit 1
                }
                if (-not $sourceWorkspaceName) {
                    Write-Host "‚ùå SOURCE_WORKSPACE_NAME not found in variable group"
                    exit 1
                }
                
                Write-Host "üìã Configuration:"
                Write-Host "   Source: $sourceLakehouseName"
                Write-Host "   Source Workspace: $sourceWorkspaceName"
                Write-Host "   Backup: $backupLakehouseName"
                Write-Host "   Backup Workspace: $backupWorkspaceName"
                
                $parametersDict = @{
                    "source_lakehouse_name" = @{ "value" = $sourceLakehouseName; "type" = "string" }
                    "source_workspace_name" = @{ "value" = $sourceWorkspaceName; "type" = "string" }
                    "backup_lakehouse_name" = @{ "value" = $backupLakehouseName; "type" = "string" }
                    "backup_workspace_name" = @{ "value" = $backupWorkspaceName; "type" = "string" }
                    "backup_tables" = @{ "value" = [bool]::Parse("${{ parameters.backup_tables }}"); "type" = "bool" }
                    "backup_files" = @{ "value" = [bool]::Parse("${{ parameters.backup_files }}"); "type" = "bool" }
                }
                
                $body = @{
                    "executionData" = @{ "parameters" = $parametersDict }
                } | ConvertTo-Json -Depth 4
                
                $startUrl = "https://api.fabric.microsoft.com/v1/workspaces/$workspaceId/items/$(notebookId)/jobs/instances?jobType=RunNotebook"
                
                try {
                    $response = Invoke-RestMethod -Uri $startUrl -Headers $headers -Method POST -Body $body -ResponseHeadersVariable responseHeaders
                    $statusUrl = $responseHeaders.location[0]
                    $jobInstanceId = ($statusUrl -split "/")[-1]
                    
                    Write-Host "‚úÖ Backup started! Job ID: $jobInstanceId"
                    Write-Host "üîó Monitor: https://app.fabric.microsoft.com/monitoringhub"
                    
                    Write-Host "##vso[task.setvariable variable=statusUrl;]$statusUrl"
                    Write-Host "##vso[task.setvariable variable=jobInstanceId;]$jobInstanceId"
                }
                catch {
                    Write-Host "‚ùå Failed to start backup: $($_.Exception.Message)"
                    exit 1
                }
              azurePowerShellVersion: 'LatestVersion'

          - task: AzurePowerShell@5
            displayName: 'Monitor Lakehouse 1 Backup'
            inputs:
              azureSubscription: '${{ variables.serviceConnection }}'
              ScriptType: 'InlineScript'
              Inline: |
                function Get-FreshToken {
                    $token = (Get-AzAccessToken -AsSecureString -ResourceUrl "https://api.fabric.microsoft.com").Token | ConvertFrom-SecureString -AsPlainText
                    return @{ "Authorization" = "Bearer $token"; "Content-Type" = "application/json" }
                }
                
                $headers = Get-FreshToken
                $lastTokenRefresh = Get-Date
                $statusUrl = "$(statusUrl)"
                $lakehouseName = "$(lakehouseName)"
                $maxAttempts = 180  # 90 minutes
                $attempt = 0
                
                Write-Host "üìä Monitoring backup for: $lakehouseName"
                
                do {
                    Start-Sleep -Seconds 30
                    $attempt++
                    
                    if (((Get-Date) - $lastTokenRefresh).TotalSeconds -gt 900) {
                        $headers = Get-FreshToken
                        $lastTokenRefresh = Get-Date
                    }
                    
                    try {
                        $response = Invoke-RestMethod -Uri $statusUrl -Headers $headers -Method GET
                        $status = $response.status
                        Write-Host "[$(Get-Date -Format 'HH:mm:ss')] [$lakehouseName] Status: $status"
                        
                        if ($status -eq "Completed") {
                            Write-Host "‚úÖ $lakehouseName backup completed!"
                            break
                        }
                        elseif ($status -eq "Failed") {
                            Write-Host "‚ùå $lakehouseName backup failed!"
                            Write-Host "##vso[task.logissue type=error]$lakehouseName backup failed."
                            exit 1
                        }
                        elseif ($status -eq "Cancelled") {
                            Write-Host "‚ö†Ô∏è $lakehouseName backup cancelled!"
                            exit 1
                        }
                    }
                    catch {
                        Write-Host "‚ö†Ô∏è Status check error: $($_.Exception.Message)"
                        if ($attempt -gt 5) { throw }
                    }
                } while ($attempt -lt $maxAttempts)
                
                if ($attempt -ge $maxAttempts) {
                    Write-Host "‚ùå $lakehouseName backup timed out!"
                    Write-Host "##vso[task.logissue type=error]$lakehouseName backup timed out."
                    exit 1
                }
              azurePowerShellVersion: 'LatestVersion'

      # =====================================================================
      # Job: Backup Lakehouse 2 (if selected or 'all')
      # =====================================================================
      - ${{ if or(eq(parameters.source_lakehouse, 'lakehouse2'), eq(parameters.source_lakehouse, 'all')) }}:
        - job: backup_lakehouse2
          displayName: Backup Lakehouse 2
          timeoutInMinutes: ${{ parameters.timeout_in_minutes }}
          ${{ if eq(parameters.source_lakehouse, 'all') }}:
            dependsOn: backup_lakehouse1

          steps:
          - task: AzurePowerShell@5
            displayName: 'Find Backup Notebook'
            inputs:
              azureSubscription: '${{ variables.serviceConnection }}'
              ScriptType: 'InlineScript'
              Inline: |
                $lakehouseName = [System.Environment]::GetEnvironmentVariable("LAKEHOUSE2_NAME")
                if (-not $lakehouseName) { $lakehouseName = "Lakehouse 2" }
                Write-Host "üîç Finding backup notebook for $lakehouseName..."
                
                $workspaceId = [System.Environment]::GetEnvironmentVariable("LAKEHOUSE_BACKUP_WORKSPACE_ID")
                
                if (-not $workspaceId) {
                    Write-Host "‚ùå LAKEHOUSE_BACKUP_WORKSPACE_ID not found"
                    exit 1
                }
                
                $bearerToken = (Get-AzAccessToken -AsSecureString -ResourceUrl "https://api.fabric.microsoft.com").Token | ConvertFrom-SecureString -AsPlainText
                $headers = @{
                  "Authorization" = "Bearer $bearerToken"
                  "Content-Type"  = "application/json"
                }
                
                $apiUrl = "https://api.fabric.microsoft.com/v1/workspaces/$workspaceId/notebooks"
                $list = Invoke-RestMethod -Uri $apiUrl -Headers $headers -Method GET
                $notebookId = ($list.value | Where-Object {$_.displayName -eq "$(notebook_name)"}).id
                
                if (-not $notebookId) {
                    Write-Host "‚ùå Notebook '$(notebook_name)' not found"
                    exit 1
                }
                
                Write-Host "‚úÖ Found notebook: $(notebook_name) ($notebookId)"
                Write-Host "##vso[task.setvariable variable=notebookId;]$notebookId"
                Write-Host "##vso[task.setvariable variable=workspaceId;]$workspaceId"
                Write-Host "##vso[task.setvariable variable=lakehouseName;]$lakehouseName"
              azurePowerShellVersion: 'LatestVersion'

          - task: AzurePowerShell@5
            displayName: 'Execute Backup for Lakehouse 2'
            inputs:
              azureSubscription: '${{ variables.serviceConnection }}'
              ScriptType: 'InlineScript'
              Inline: |
                $lakehouseName = "$(lakehouseName)"
                Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                Write-Host "üíæ Starting Backup: $lakehouseName"
                Write-Host "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
                
                $workspaceId = "$(workspaceId)"
                $fabricToken = (Get-AzAccessToken -AsSecureString -ResourceUrl "https://api.fabric.microsoft.com").Token | ConvertFrom-SecureString -AsPlainText
                $headers = @{
                    "Authorization" = "Bearer $fabricToken"
                    "Content-Type" = "application/json"
                }
                
                # Get lakehouse names from variable group
                $sourceLakehouseName = [System.Environment]::GetEnvironmentVariable("LAKEHOUSE2_NAME")
                $sourceWorkspaceName = [System.Environment]::GetEnvironmentVariable("SOURCE_WORKSPACE_NAME")
                $backupLakehouseName = "$(backup_lakehouse_name)"
                $backupWorkspaceName = "$(backup_workspace_name)"
                
                if (-not $sourceLakehouseName) {
                    Write-Host "‚ùå LAKEHOUSE2_NAME not found in variable group"
                    exit 1
                }
                if (-not $sourceWorkspaceName) {
                    Write-Host "‚ùå SOURCE_WORKSPACE_NAME not found in variable group"
                    exit 1
                }
                
                Write-Host "üìã Configuration:"
                Write-Host "   Source: $sourceLakehouseName"
                Write-Host "   Source Workspace: $sourceWorkspaceName"
                Write-Host "   Backup: $backupLakehouseName"
                Write-Host "   Backup Workspace: $backupWorkspaceName"
                
                $parametersDict = @{
                    "source_lakehouse_name" = @{ "value" = $sourceLakehouseName; "type" = "string" }
                    "source_workspace_name" = @{ "value" = $sourceWorkspaceName; "type" = "string" }
                    "backup_lakehouse_name" = @{ "value" = $backupLakehouseName; "type" = "string" }
                    "backup_workspace_name" = @{ "value" = $backupWorkspaceName; "type" = "string" }
                    "backup_tables" = @{ "value" = [bool]::Parse("${{ parameters.backup_tables }}"); "type" = "bool" }
                    "backup_files" = @{ "value" = [bool]::Parse("${{ parameters.backup_files }}"); "type" = "bool" }
                }
                
                $body = @{
                    "executionData" = @{ "parameters" = $parametersDict }
                } | ConvertTo-Json -Depth 4
                
                $startUrl = "https://api.fabric.microsoft.com/v1/workspaces/$workspaceId/items/$(notebookId)/jobs/instances?jobType=RunNotebook"
                
                try {
                    $response = Invoke-RestMethod -Uri $startUrl -Headers $headers -Method POST -Body $body -ResponseHeadersVariable responseHeaders
                    $statusUrl = $responseHeaders.location[0]
                    $jobInstanceId = ($statusUrl -split "/")[-1]
                    
                    Write-Host "‚úÖ Backup started! Job ID: $jobInstanceId"
                    Write-Host "üîó Monitor: https://app.fabric.microsoft.com/monitoringhub"
                    
                    Write-Host "##vso[task.setvariable variable=statusUrl;]$statusUrl"
                    Write-Host "##vso[task.setvariable variable=jobInstanceId;]$jobInstanceId"
                }
                catch {
                    Write-Host "‚ùå Failed to start backup: $($_.Exception.Message)"
                    exit 1
                }
              azurePowerShellVersion: 'LatestVersion'

          - task: AzurePowerShell@5
            displayName: 'Monitor Lakehouse 2 Backup'
            inputs:
              azureSubscription: '${{ variables.serviceConnection }}'
              ScriptType: 'InlineScript'
              Inline: |
                function Get-FreshToken {
                    $token = (Get-AzAccessToken -AsSecureString -ResourceUrl "https://api.fabric.microsoft.com").Token | ConvertFrom-SecureString -AsPlainText
                    return @{ "Authorization" = "Bearer $token"; "Content-Type" = "application/json" }
                }
                
                $headers = Get-FreshToken
                $lastTokenRefresh = Get-Date
                $statusUrl = "$(statusUrl)"
                $lakehouseName = "$(lakehouseName)"
                $maxAttempts = 180  # 90 minutes
                $attempt = 0
                
                Write-Host "üìä Monitoring backup for: $lakehouseName"
                
                do {
                    Start-Sleep -Seconds 30
                    $attempt++
                    
                    if (((Get-Date) - $lastTokenRefresh).TotalSeconds -gt 900) {
                        $headers = Get-FreshToken
                        $lastTokenRefresh = Get-Date
                    }
                    
                    try {
                        $response = Invoke-RestMethod -Uri $statusUrl -Headers $headers -Method GET
                        $status = $response.status
                        Write-Host "[$(Get-Date -Format 'HH:mm:ss')] [$lakehouseName] Status: $status"
                        
                        if ($status -eq "Completed") {
                            Write-Host "‚úÖ $lakehouseName backup completed!"
                            break
                        }
                        elseif ($status -eq "Failed") {
                            Write-Host "‚ùå $lakehouseName backup failed!"
                            Write-Host "##vso[task.logissue type=error]$lakehouseName backup failed."
                            exit 1
                        }
                        elseif ($status -eq "Cancelled") {
                            Write-Host "‚ö†Ô∏è $lakehouseName backup cancelled!"
                            exit 1
                        }
                    }
                    catch {
                        Write-Host "‚ö†Ô∏è Status check error: $($_.Exception.Message)"
                        if ($attempt -gt 5) { throw }
                    }
                } while ($attempt -lt $maxAttempts)
                
                if ($attempt -ge $maxAttempts) {
                    Write-Host "‚ùå $lakehouseName backup timed out!"
                    Write-Host "##vso[task.logissue type=error]$lakehouseName backup timed out."
                    exit 1
                }
              azurePowerShellVersion: 'LatestVersion'
