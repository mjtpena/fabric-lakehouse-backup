# GitHub Actions workflow to validate notebook structure and syntax
name: Validate Notebooks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
    paths:
      - '**/*.Notebook/**'
      - '*.yml'
      - '*.md'

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyflakes
    
    - name: Validate Fabric notebook Python files
      run: |
        python -c "
        import ast
        import sys
        import os
        
        # Find all Fabric notebook Python files
        notebook_dirs = [
            'nb_lakehouse_backup.Notebook',
            'nb_lakehouse_cleanup.Notebook',
            'nb_lakehouse_restore.Notebook'
        ]
        
        errors_found = False
        
        for notebook_dir in notebook_dirs:
            notebook_file = os.path.join(notebook_dir, 'notebook-content.py')
            if os.path.exists(notebook_file):
                try:
                    with open(notebook_file, 'r') as f:
                        content = f.read()
                    # Parse the Python file to check for syntax errors
                    ast.parse(content)
                    print(f'✅ {notebook_file}: Valid Python syntax')
                except SyntaxError as e:
                    print(f'❌ {notebook_file}: Syntax error - {str(e)}')
                    errors_found = True
                except Exception as e:
                    print(f'❌ {notebook_file}: Error - {str(e)}')
                    errors_found = True
            else:
                print(f'⚠️  {notebook_file}: File not found')
        
        if errors_found:
            sys.exit(1)
        
        print('All notebook validations completed')
        "
    
    - name: Check documentation links
      run: |
        python -c "
        import os
        import re
        
        # Check for broken relative links in markdown files
        md_files = []
        for root, dirs, files in os.walk('.'):
            # Skip hidden directories
            dirs[:] = [d for d in dirs if not d.startswith('.')]
            for file in files:
                if file.endswith('.md'):
                    md_files.append(os.path.join(root, file))
        
        for md_file in md_files:
            with open(md_file, 'r') as f:
                content = f.read()
                # Find markdown links
                links = re.findall(r'\[.*?\]\((.*?)\)', content)
                for link in links:
                    # Skip URLs and anchors
                    if link.startswith('http') or link.startswith('#'):
                        continue
                    # Handle links with anchors
                    link_path = link.split('#')[0]
                    if link_path:
                        full_path = os.path.join(os.path.dirname(md_file), link_path)
                        if not os.path.exists(full_path):
                            print(f'⚠️  Broken link in {md_file}: {link}')
        
        print('✅ Documentation link check completed')
        "
